name: Deploy to Webzdarma.cz Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-to-webzdarma:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://kilma-pubg.wz.cz:8080/
    
    steps:
      - name: üöö Checkout
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Remove cache to avoid lock file conflicts
          
      - name: üîß Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          # Clear npm cache to avoid conflicts
          npm cache clean --force
          # Install dependencies and update lock file
          npm install
          echo "‚úÖ Dependencies installed successfully"
        
      - name: üìÅ Build and prepare files for webzdarma.cz
        run: |
          echo "üèóÔ∏è Building PUBG Tracker for kilma-pubg.wz.cz:8080"
          
          # Create deployment directory
          mkdir -p deploy
          
          # Copy main application files
          cp index.html deploy/
          
          # Force copy data.json with verification
          echo "üìä Copying data.json..."
          ls -la data.json
          cp data.json deploy/
          echo "‚úÖ data.json copied. Size: $(wc -c < deploy/data.json) bytes"
          
          # Copy deployment timestamp
          cp deployment-timestamp.txt deploy/ 2>/dev/null || echo "No timestamp file"
          
          # Copy public directory if exists
          if [ -d "public" ]; then
            cp -r public deploy/
            echo "üìÇ Copied public directory"
          fi
          
          # Copy server files (in case webzdarma supports Node.js)
          cp server.js deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          
          # Create .htaccess for Apache/webzdarma.cz
          cat > deploy/.htaccess << 'EOF'
          # PUBG Tracker - Webzdarma.cz Configuration
          DirectoryIndex index.html
          
          # Enable rewrite engine
          RewriteEngine On
          
          # Handle SPA routing
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ index.html [QSA,L]
          
          # Security headers
          <IfModule mod_headers.c>
              Header always set X-Frame-Options DENY
              Header always set X-Content-Type-Options nosniff
          </IfModule>
          
          # Cache optimization
          <IfModule mod_expires.c>
              ExpiresActive On
              ExpiresByType text/css "access plus 1 month"
              ExpiresByType application/javascript "access plus 1 month"
              # Disable caching for JSON data to ensure fresh data loading
              ExpiresByType application/json "access plus 0 seconds"
          </IfModule>
          
          # Force no-cache for data.json specifically
          <Files "data.json">
              <IfModule mod_headers.c>
                  Header set Cache-Control "no-cache, no-store, must-revalidate"
                  Header set Pragma "no-cache" 
                  Header set Expires "0"
              </IfModule>
          </Files>
          
          # Compress files for better performance
          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json
          </IfModule>
          EOF
          
          # Create deployment info
          cat > deploy/deployment-info.txt << EOF
          PUBG Tracker - Webzdarma.cz Deployment
          =====================================
          Target URL: http://kilma-pubg.wz.cz:8080/
          Deployed: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          
          Files deployed:
          - index.html (Main dashboard)
          - data.json (Match data)
          - server.js (Express server - if supported)
          - package.json (Dependencies)
          - .htaccess (Apache configuration)
          EOF
          
          echo "üìã Files prepared for deployment:"
          ls -la deploy/
          
      - name: üì§ Deploy to Webzdarma.cz via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.WEBZDARMA_FTP_SERVER }}
          username: ${{ secrets.WEBZDARMA_FTP_USERNAME }}  
          password: ${{ secrets.WEBZDARMA_FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.WEBZDARMA_FTP_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/PUBG.JS
            
      - name: ‚úÖ Deployment Success
        if: success()
        run: |
          echo "üéâ PUBG Tracker successfully deployed!"
          echo "üåê Live URL: http://kilma-pubg.wz.cz:8080/"
          echo "üìÅ Deployed to webzdarma.cz hosting"
          echo "‚è∞ Deployment completed at: $(date)"
          
      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "üí• Deployment to webzdarma.cz failed!"
          echo "üîç Check the following:"
          echo "   - FTP credentials in GitHub Secrets"
          echo "   - FTP server connectivity" 
          echo "   - Directory permissions on webzdarma.cz"
          echo "   - Server directory path configuration"