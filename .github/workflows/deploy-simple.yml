name: Deploy to Webzdarma.cz

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://kilma-pubg.wz.cz:8080/
    
    steps:
      - name: ðŸšš Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“ Prepare files
        run: |
          echo "ðŸ—ï¸ Preparing files for deployment"
          mkdir -p deploy
          
          # Copy HTML files
          cp *.html deploy/ 2>/dev/null || echo "Copying HTML files"
          
          # Copy JavaScript files
          cp career.js deploy/ 2>/dev/null || echo "No career.js"
          
          # Copy public directory
          if [ -d "public" ]; then
            mkdir -p deploy/public
            cp -r public/* deploy/public/
            # Also copy public files to root for Express static serving compatibility
            cp -r public/* deploy/
            echo "ðŸ“‚ Copied public directory (both to /public and root)"
          fi
          
          # Copy React Video Gallery build
          if [ -d "pubg-react/dist" ]; then
            mkdir -p deploy/videos
            cp -r pubg-react/dist/* deploy/videos/
            echo "ðŸŽ¥ Copied React Video Gallery to /videos"
          fi
          
          # Copy server files
          cp server.js deploy/
          cp package*.json deploy/
          
          # Copy ALL JSON data files
          cp *.json deploy/ 2>/dev/null || echo "Copying JSON files"
          
          # Create .htaccess
          cat > deploy/.htaccess << 'EOF'
          DirectoryIndex index.html
          RewriteEngine On
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ index.html [QSA,L]
          
          <Files "*.json">
              <IfModule mod_headers.c>
                  Header set Cache-Control "no-cache, no-store, must-revalidate"
              </IfModule>
          </Files>
          EOF
          
          echo "ðŸ“‹ Files ready:"
          ls -lah deploy/
          
      - name: ðŸ“¤ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.WEBZDARMA_FTP_SERVER }}
          username: ${{ secrets.WEBZDARMA_FTP_USERNAME }}  
          password: ${{ secrets.WEBZDARMA_FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.WEBZDARMA_FTP_DIR }}
          dangerous-clean-slate: true
          exclude: |
            **/.git*
            **/node_modules/**
            **/.env
            **/PUBG.JS
            **/data_backup_*.json
            **/.github/**
            
      - name: âœ… Done
        run: echo "ðŸŽ‰ Deployed to http://kilma-pubg.wz.cz:8080/"
