<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PUBG Tracker Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      padding: 16px;
      margin: 0;
      background-color: #f8f9fa;
      line-height: 1.6;
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .day { 
      margin-bottom: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .day:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .date-header {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
      border: none !important;
      width: 100%;
      text-align: left;
      font-family: inherit;
      font-size: inherit;
      margin: 0;
      box-sizing: border-box;
    }
    
    .date-header:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    
    .date-header:focus {
      outline: 2px solid #ffffff40;
      outline-offset: -2px;
    }
    
    .date-title {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .date-info {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    .dropdown-arrow {
      font-size: 1.2rem;
      transition: transform 0.3s ease;
      font-weight: bold;
    }
    
    .dropdown-arrow.expanded {
      transform: rotate(180deg);
    }
    
    .charts-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.3s ease;
      padding: 0 24px;
    }
    
    .charts-content.expanded {
      max-height: 2000px;
      padding: 24px;
      transition: max-height 0.5s ease-in, padding 0.3s ease;
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      width: 100%;
    }
    
    .chart-wrapper {
      position: relative;
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #e9ecef;
      min-height: 400px;
    }
    
    canvas {
      width: 100% !important;
      height: 350px !important;
      max-height: 350px;
    }
    
    .summary {
      margin: 16px 0;
      font-size: 0.9rem;
      color: #6c757d;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }
    
    h1 {
      margin: 0 0 32px 0;
      color: #2c3e50;
      font-size: 2.5rem;
      text-align: center;
      font-weight: 700;
    }
    
    .controls {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .toggle-all-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .toggle-all-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1fa085 100%);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    
    .toggle-all-btn:focus {
      outline: 2px solid #28a74580;
      outline-offset: 2px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      h1 {
        font-size: 2rem;
        margin-bottom: 24px;
      }
      
      .controls {
        margin-bottom: 24px;
      }
      
      .toggle-all-btn {
        padding: 10px 20px;
        font-size: 0.85rem;
      }
      
      .day {
        margin-bottom: 20px;
      }
      
      .date-header {
        padding: 16px 20px;
      }
      
      .date-title {
        font-size: 1.25rem;
      }
      
      .date-info {
        font-size: 0.8rem;
      }
      
      .charts-content.expanded {
        padding: 20px;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .chart-wrapper {
        padding: 12px;
        min-height: 320px;
      }
      
      canvas {
        height: 280px !important;
      }
      
      .summary {
        font-size: 0.85rem;
        padding: 10px;
      }
    }
    
    /* Small mobile devices */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      .toggle-all-btn {
        padding: 8px 16px;
        font-size: 0.8rem;
      }
      
      .day {
        margin-bottom: 16px;
      }
      
      .date-header {
        padding: 12px 16px;
      }
      
      .date-title {
        font-size: 1.1rem;
      }
      
      .date-info {
        font-size: 0.75rem;
      }
      
      .dropdown-arrow {
        font-size: 1rem;
      }
      
      .charts-content.expanded {
        padding: 16px;
      }
      
      .chart-wrapper {
        min-height: 280px;
      }
      
      canvas {
        height: 240px !important;
      }
    }
    
    /* Large screens */
    @media (min-width: 1200px) {
      .charts-container {
        grid-template-columns: repeat(3, 1fr);
      }
      
      canvas {
        height: 380px !important;
      }
    }
    
    /* Extra large screens */
    @media (min-width: 1600px) {
      .charts-container {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Print styles */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .day {
        box-shadow: none;
        border: 1px solid #ccc;
        break-inside: avoid;
        margin-bottom: 20px;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PUBG Daily Summary</h1>
    <div class="controls">
      <button id="toggleAll" class="toggle-all-btn">Expand All</button>
    </div>
    <div id="dashboard"></div>
  </div>

  <script>
    console.log('Starting to fetch data...');
    fetch('/data.json')
      .then(res => {
        console.log('Fetch response:', res.status);
        return res.json();
      })
      .then(data => {
        console.log('Data received:', data.length, 'matches');
        // Group matches by date
        const grouped = {};
        data.forEach(match => {
          const date = match.date.split('T')[0];
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(match);
        });

        const container = document.getElementById('dashboard');
        const dates = Object.entries(grouped);
        let isFirstDate = true;

        for (const [date, matches] of dates) {
          console.log('Creating button for date:', date);
          const div = document.createElement('div');
          div.className = 'day';
          
          // Create clickable date header
          const headerButton = document.createElement('button');
          headerButton.className = 'date-header';
          
          // Format the date properly
          const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          
          headerButton.innerHTML = `
            <div>
              <div class="date-title">${formattedDate}</div>
              <div class="date-info">${matches.length} matches played</div>
            </div>
            <span class="dropdown-arrow">â–¼</span>
          `;
          
          console.log('Button created for:', formattedDate);
          
          // Create collapsible content container
          const contentDiv = document.createElement('div');
          contentDiv.className = 'charts-content';
          
          div.appendChild(headerButton);
          div.appendChild(contentDiv);
          console.log('Button appended to div');

          // Calculate daily stats for each unique player
          const playerStats = {};
          const weaponData = {};
          
          matches.forEach(match => {
            match.team.forEach(player => {
              if (!playerStats[player.name]) {
                playerStats[player.name] = {
                  kills: 0,
                  damage: 0,
                  headshots: 0,
                  assists: 0,
                  heals: 0,
                  revives: 0,
                  timeSurvived: 0,
                  matches: 0,
                  weapons: {},
                  longestKill: 0
                };
              }
              
              // Basic stats
              playerStats[player.name].kills += player.kills || 0;
              playerStats[player.name].damage += player.damage || 0;
              playerStats[player.name].headshots += player.headshots || 0;
              playerStats[player.name].assists += player.assists || 0;
              playerStats[player.name].heals += player.heals || 0;
              playerStats[player.name].revives += player.revives || 0;
              playerStats[player.name].timeSurvived += player.timeSurvived || 0;
              playerStats[player.name].matches++;
              
              // Weapon statistics
              if (player.weapons) {
                Object.entries(player.weapons).forEach(([weapon, kills]) => {
                  if (!playerStats[player.name].weapons[weapon]) {
                    playerStats[player.name].weapons[weapon] = 0;
                  }
                  playerStats[player.name].weapons[weapon] += kills;
                  
                  // Global weapon tracking for weapon chart
                  if (!weaponData[weapon]) {
                    weaponData[weapon] = 0;
                  }
                  weaponData[weapon] += kills;
                });
              }
              
              // Longest kill tracking
              if (player.weaponStats && player.weaponStats.longestKill > playerStats[player.name].longestKill) {
                playerStats[player.name].longestKill = player.weaponStats.longestKill;
              }
            });
          });

          const names = Object.keys(playerStats);
          const kills = names.map(name => playerStats[name].kills);
          const damage = names.map(name => playerStats[name].damage);
          const headshots = names.map(name => playerStats[name].headshots);
          const assists = names.map(name => playerStats[name].assists);
          const heals = names.map(name => playerStats[name].heals);
          const revives = names.map(name => playerStats[name].revives);
          const avgSurvival = names.map(name => 
            Math.round(playerStats[name].timeSurvived / playerStats[name].matches)
          );
          
          // Prepare weapon data (top 5 weapons for this date)
          const topWeapons = Object.entries(weaponData)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          const weaponNames = topWeapons.map(([weapon, _]) => weapon);
          const weaponKills = topWeapons.map(([_, kills]) => kills);

          // Create charts container inside the collapsible content
          const chartsContainer = document.createElement('div');
          chartsContainer.className = 'charts-container';

          // Create wrapper for each chart
          const killsWrapper = document.createElement('div');
          killsWrapper.className = 'chart-wrapper';
          killsWrapper.innerHTML = `<canvas id="kills-${date}"></canvas>`;

          const damageWrapper = document.createElement('div');
          damageWrapper.className = 'chart-wrapper';
          damageWrapper.innerHTML = `<canvas id="damage-${date}"></canvas>`;

          const headshotsWrapper = document.createElement('div');
          headshotsWrapper.className = 'chart-wrapper';
          headshotsWrapper.innerHTML = `<canvas id="headshots-${date}"></canvas>`;

          // Create weapon statistics wrappers
          const weaponKillsWrapper = document.createElement('div');
          weaponKillsWrapper.className = 'chart-wrapper';
          weaponKillsWrapper.innerHTML = `<canvas id="weapon-kills-${date}"></canvas>`;

          const assistsWrapper = document.createElement('div');
          assistsWrapper.className = 'chart-wrapper';
          assistsWrapper.innerHTML = `<canvas id="assists-${date}"></canvas>`;

          const survivalWrapper = document.createElement('div');
          survivalWrapper.className = 'chart-wrapper';
          survivalWrapper.innerHTML = `<canvas id="survival-${date}"></canvas>`;

          // Add all chart wrappers to the container
          chartsContainer.appendChild(killsWrapper);
          chartsContainer.appendChild(damageWrapper);
          chartsContainer.appendChild(headshotsWrapper);
          chartsContainer.appendChild(weaponKillsWrapper);
          chartsContainer.appendChild(assistsWrapper);
          chartsContainer.appendChild(survivalWrapper);

          // Add the charts container to the collapsible content
          contentDiv.appendChild(chartsContainer);
          
          container.appendChild(div);
          
          // Add click functionality to toggle dropdown
          headerButton.addEventListener('click', () => {
            const isExpanded = contentDiv.classList.contains('expanded');
            const arrow = headerButton.querySelector('.dropdown-arrow');
            
            if (isExpanded) {
              contentDiv.classList.remove('expanded');
              arrow.classList.remove('expanded');
              headerButton.setAttribute('aria-expanded', 'false');
            } else {
              contentDiv.classList.add('expanded');
              arrow.classList.add('expanded');
              headerButton.setAttribute('aria-expanded', 'true');
              
              // Trigger chart resize after expansion animation completes
              setTimeout(() => {
                const dateCharts = [
                  Chart.getChart(`kills-${date}`),
                  Chart.getChart(`damage-${date}`),
                  Chart.getChart(`headshots-${date}`),
                  Chart.getChart(`weapon-kills-${date}`),
                  Chart.getChart(`assists-${date}`),
                  Chart.getChart(`survival-${date}`)
                ];
                dateCharts.forEach(chart => {
                  if (chart) chart.resize();
                });
              }, 500);
            }
          });
          
          // Set initial accessibility attributes
          headerButton.setAttribute('aria-controls', `charts-${date}`);
          contentDiv.setAttribute('id', `charts-${date}`);
          
          // Expand the first (most recent) date by default
          if (isFirstDate) {
            contentDiv.classList.add('expanded');
            headerButton.querySelector('.dropdown-arrow').classList.add('expanded');
            headerButton.setAttribute('aria-expanded', 'true');
            isFirstDate = false;
          } else {
            headerButton.setAttribute('aria-expanded', 'false');
          }
          
          // Add keyboard support
          headerButton.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              headerButton.click();
            }
          });

          // Responsive chart options
          const isMobile = window.innerWidth <= 768;
          const isSmallMobile = window.innerWidth <= 480;
          
          const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#ffffff',
                borderWidth: 1,
                cornerRadius: 6,
                displayColors: true,
                padding: 12
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)',
                  lineWidth: 1
                },
                ticks: {
                  color: '#666',
                  font: {
                    size: isMobile ? 10 : 12
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#666',
                  maxRotation: isMobile ? 90 : 45,
                  minRotation: isMobile ? 90 : 45,
                  font: {
                    size: isSmallMobile ? 9 : isMobile ? 10 : 12
                  },
                  maxTicksLimit: isMobile ? 8 : 12
                }
              }
            },
            elements: {
              bar: {
                borderRadius: 4,
                borderSkipped: false,
                borderWidth: 0
              }
            },
            layout: {
              padding: {
                top: isMobile ? 10 : 20,
                bottom: isMobile ? 5 : 10,
                left: isMobile ? 5 : 10,
                right: isMobile ? 5 : 10
              }
            }
          };

          new Chart(document.getElementById(`kills-${date}`), {
            type: 'bar',
            data: {
              labels: names,
              datasets: [{ 
                label: 'Total Kills', 
                data: kills, 
                backgroundColor: 'orange'
              }]
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: true,
                  text: 'Kills per Player',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                }
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });

          new Chart(document.getElementById(`damage-${date}`), {
            type: 'bar',
            data: {
              labels: names,
              datasets: [{ 
                label: 'Total Damage', 
                data: damage.map(d => Math.round(d)), 
                backgroundColor: 'red'
              }]
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: true,
                  text: 'Damage per Player',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                }
              }
            }
          });

          new Chart(document.getElementById(`headshots-${date}`), {
            type: 'bar',
            data: {
              labels: names,
              datasets: [{ 
                label: 'Total Headshots', 
                data: headshots, 
                backgroundColor: 'blue'
              }]
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: true,
                  text: 'Headshots per Player',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                }
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });

          // Weapon Kills Chart (Pie Chart)
          new Chart(document.getElementById(`weapon-kills-${date}`), {
            type: 'doughnut',
            data: {
              labels: weaponNames.length > 0 ? weaponNames : ['No weapon data'],
              datasets: [{ 
                label: 'Kills by Weapon',
                data: weaponKills.length > 0 ? weaponKills : [1],
                backgroundColor: [
                  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                  '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    font: {
                      size: isMobile ? 10 : 12
                    },
                    padding: 10,
                    usePointStyle: true
                  }
                },
                title: {
                  display: true,
                  text: 'Top Weapons Used',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#ffffff',
                  bodyColor: '#ffffff',
                  cornerRadius: 6,
                  padding: 12
                }
              },
              layout: {
                padding: isMobile ? 10 : 20
              }
            }
          });

          // Assists Chart
          new Chart(document.getElementById(`assists-${date}`), {
            type: 'bar',
            data: {
              labels: names,
              datasets: [{ 
                label: 'Assists', 
                data: assists, 
                backgroundColor: '#28a745'
              }]
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: true,
                  text: 'Assists & Support Stats',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                }
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });

          // Survival Time Chart
          new Chart(document.getElementById(`survival-${date}`), {
            type: 'bar',
            data: {
              labels: names,
              datasets: [
                { 
                  label: 'Avg Survival (minutes)', 
                  data: avgSurvival.map(time => Math.round(time / 60)), 
                  backgroundColor: '#17a2b8'
                },
                { 
                  label: 'Heals Used', 
                  data: heals, 
                  backgroundColor: '#6f42c1'
                }
              ]
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: true,
                  text: 'Survival & Healing Stats',
                  font: {
                    size: isMobile ? 14 : 16,
                    weight: 'bold'
                  },
                  color: '#2c3e50',
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                },
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    font: {
                      size: isMobile ? 10 : 12
                    }
                  }
                }
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  beginAtZero: true
                }
              }
            }
          });
        }

        // Add functionality to toggle all dropdowns
        const toggleAllBtn = document.getElementById('toggleAll');
        let allExpanded = false;
        
        toggleAllBtn.addEventListener('click', () => {
          const dateHeaders = document.querySelectorAll('.date-header');
          const chartsContents = document.querySelectorAll('.charts-content');
          const arrows = document.querySelectorAll('.dropdown-arrow');
          
          allExpanded = !allExpanded;
          
          dateHeaders.forEach((header, index) => {
            const content = chartsContents[index];
            const arrow = arrows[index];
            
            if (allExpanded) {
              content.classList.add('expanded');
              arrow.classList.add('expanded');
              header.setAttribute('aria-expanded', 'true');
            } else {
              content.classList.remove('expanded');
              arrow.classList.remove('expanded');
              header.setAttribute('aria-expanded', 'false');
            }
          });
          
          toggleAllBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
          
          // Resize charts after animation completes
          if (allExpanded) {
            setTimeout(() => {
              Chart.instances.forEach(chart => {
                if (chart) chart.resize();
              });
            }, 500);
          }
        });
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        const container = document.getElementById('dashboard');
        container.innerHTML = `
          <div style="
            padding: 20px; 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
            border-radius: 6px;
            margin: 20px 0;
          ">
            <h3>Error Loading Data</h3>
            <p>Could not load match data. Please ensure the server is running and data.json exists.</p>
            <p>Error: ${error.message}</p>
          </div>
        `;
      });

    // Handle window resize for responsive charts
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Trigger chart resize after window resize completes
        Chart.instances.forEach(chart => {
          if (chart) {
            chart.resize();
          }
        });
      }, 250);
    });

    // Add loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading';
    loadingDiv.innerHTML = `
      <div style="
        display: flex; 
        justify-content: center; 
        align-items: center; 
        height: 200px; 
        font-size: 1.2rem; 
        color: #666;
        flex-direction: column;
      ">
        <div style="
          width: 40px; 
          height: 40px; 
          border: 4px solid #f3f3f3; 
          border-top: 4px solid #007bff; 
          border-radius: 50%; 
          animation: spin 1s linear infinite; 
          margin-bottom: 16px;
        "></div>
        Loading PUBG data...
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    `;
    
    document.getElementById('dashboard').appendChild(loadingDiv);
    
    // Remove loading indicator after data loads
    setTimeout(() => {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.remove();
      }
    }, 2000);
  </script>
</body>
</html>
